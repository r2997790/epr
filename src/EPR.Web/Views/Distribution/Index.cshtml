@{
    ViewData["Title"] = "Distribution - ASN Management";
    var initialAsnId = ViewBag.AsnId as int?;
}


<div class="container-fluid distribution-page" data-initial-asn-id="@(initialAsnId?.ToString() ?? "")">
    <!-- Page header - matches other pages (Products, etc.) -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <div>
            <h1 class="mb-0"><i class="bi bi-truck"></i> Distribution - ASN Management</h1>
            <p class="text-muted mb-0 small">Advanced Shipping Notices (EDI 856, DESADV, GS1 XML)</p>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <button id="btnCreateDummyData" type="button" class="btn btn-outline-info btn-sm" title="Create sample ASN data for testing">
                <i class="bi bi-database-add"></i> Create Sample Data
            </button>
            <button id="btnCreateAsn" type="button" class="btn btn-success btn-sm">
                <i class="bi bi-plus-circle"></i> Create New ASN
            </button>
            <button id="btnUploadAsn" type="button" class="btn btn-primary btn-sm"
                    onclick="event.preventDefault(); event.stopPropagation(); 
                            if (typeof window.moveDistributionModalToBody === 'function') window.moveDistributionModalToBody('uploadModal');
                            if (typeof bootstrap !== 'undefined') { var m = new bootstrap.Modal(document.getElementById('uploadModal')); m.show(); } else { alert('Bootstrap not loaded.'); }">
                <i class="bi bi-upload"></i> Upload ASN
            </button>
            <button id="btnRefresh" type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-upload"></i> Upload ASN File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select ASN File(s)</label>
                        <input type="file" class="form-control" id="asnFileInput" accept=".xml,.edi,.txt" multiple>
                        <div class="form-text">
                            Supported formats: EDI 856 (.edi), DESADV (.edi), GS1 XML (.xml)
                            <br>You can select multiple files at once
                        </div>
                    </div>
                    <div id="uploadProgress" style="display: none;">
                        <div class="mb-2">
                            <strong>Upload Progress</strong>
                        </div>
                        <div class="progress mb-2" style="height: 25px;">
                            <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%">0%</div>
                        </div>
                        <div id="uploadProgressText" class="small text-muted">Preparing...</div>
                        <div id="uploadFileList" class="mt-2 small"></div>
                    </div>
                    <div id="uploadStatus" class="alert" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCancelUpload">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnProcessUpload">
                        <i class="bi bi-check-circle"></i> Upload & Process
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create ASN Modal -->
    <div class="modal fade" id="createAsnModal" tabindex="-1" data-bs-backdrop="true" data-bs-keyboard="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Create New ASN Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="asnType" id="asnTypeReal" value="real" checked>
                            <label class="form-check-label" for="asnTypeReal">
                                <i class="bi bi-check-circle text-success"></i> Real ASN
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="asnType" id="asnTypeSimulated" value="simulated">
                            <label class="form-check-label" for="asnTypeSimulated">
                                <i class="bi bi-lightning-charge text-warning"></i> Simulated ASN
                            </label>
                        </div>
                        <small class="form-text text-muted d-block mt-1">
                            Simulated ASNs are used to model onward journeys where full visibility may not be known.
                        </small>
                    </div>
                    <form id="createAsnForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ASN Number <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="createAsnNumber" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Ship Date <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="createShipDate" required>
                                </div>
                            </div>
                        </div>
                        <h6 class="mt-3 mb-2">Shipper Information</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Shipper GLN</label>
                                    <input type="text" class="form-control" id="createShipperGln" maxlength="13">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Shipper Name</label>
                                    <input type="text" class="form-control" id="createShipperName">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Shipper Address</label>
                            <input type="text" class="form-control" id="createShipperAddress">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Shipper City</label>
                                    <input type="text" class="form-control" id="createShipperCity">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Shipper Country</label>
                                    <input type="text" class="form-control" id="createShipperCountry" maxlength="2" placeholder="e.g., GB">
                                </div>
                            </div>
                        </div>
                        <h6 class="mt-3 mb-2">Receiver Information</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Receiver GLN</label>
                                    <input type="text" class="form-control" id="createReceiverGln" maxlength="13">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Receiver Name</label>
                                    <input type="text" class="form-control" id="createReceiverName">
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle"></i> <strong>Note:</strong> You can add pallets and line items after creating the ASN by editing it in the detail view.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="btnSaveCreateAsn">
                        <i class="bi bi-check-circle"></i> Create ASN
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Pallet Modal -->
    <div class="modal fade" id="editPalletModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Pallet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editPalletShipmentId" />
                    <input type="hidden" id="editPalletId" />
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label">SSCC</label>
                            <input type="text" class="form-control" id="editPalletSscc" maxlength="18" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Package Type</label>
                            <input type="text" class="form-control" id="editPalletPackageType" placeholder="e.g. PLT" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Gross Weight (kg)</label>
                            <input type="number" step="0.01" class="form-control" id="editPalletGrossWeight" />
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Destination Name</label>
                        <input type="text" class="form-control" id="editPalletDestName" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Destination Address</label>
                        <input type="text" class="form-control" id="editPalletDestAddress" />
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" id="editPalletDestCity" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Postal Code</label>
                            <input type="text" class="form-control" id="editPalletDestPostalCode" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Country Code</label>
                            <input type="text" class="form-control" id="editPalletDestCountryCode" maxlength="2" placeholder="GB" />
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Destination GLN</label>
                        <input type="text" class="form-control" id="editPalletDestGln" maxlength="13" />
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="editPalletIsSimulated" />
                        <label class="form-check-label" for="editPalletIsSimulated">Simulated pallet</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnSaveEditPallet"><i class="bi bi-check"></i> Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Line Item Modal -->
    <div class="modal fade" id="editLineItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Line Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editLineItemShipmentId" />
                    <input type="hidden" id="editLineItemPalletId" />
                    <input type="hidden" id="editLineItemId" />
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label">GTIN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editLineItemGtin" required maxlength="14" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Description <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editLineItemDescription" required />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <label class="form-label">Quantity <span class="text-danger">*</span></label>
                            <input type="number" step="0.01" class="form-control" id="editLineItemQuantity" required />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Unit of Measure</label>
                            <input type="text" class="form-control" id="editLineItemUnitOfMeasure" placeholder="e.g. EA, PCE" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Line Number</label>
                            <input type="number" class="form-control" id="editLineItemLineNumber" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label">Batch Number</label>
                            <input type="text" class="form-control" id="editLineItemBatchNumber" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Best Before Date</label>
                            <input type="date" class="form-control" id="editLineItemBestBeforeDate" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label">PO Line Reference</label>
                            <input type="text" class="form-control" id="editLineItemPoLineRef" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Supplier Article Number</label>
                            <input type="text" class="form-control" id="editLineItemSupplierArticle" />
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="editLineItemIsSimulated" />
                        <label class="form-check-label" for="editLineItemIsSimulated">Simulated line item</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnSaveEditLineItem"><i class="bi bi-check"></i> Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- List View -->
    <div id="listView" class="card">
        <div class="card-body">
            <div id="loadingIndicator" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading ASN shipments...</p>
                <p class="mt-2 text-muted small">If this takes too long, please refresh the page.</p>
            </div>

            <div id="shipmentsContainer" style="display: none;">
                <div class="table-responsive distribution-asn-table-wrap">
                    <table class="table table-hover" id="shipmentsTable">
                        <thead class="table-light">
                            <tr>
                                <th>ASN Number</th>
                                <th>Shipper</th>
                                <th>Receiver</th>
                                <th>Ship Date</th>
                                <th>Carrier/Vehicle</th>
                                <th>Pallets</th>
                                <th>Destinations</th>
                                <th>Chain</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="shipmentsTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="noShipments" class="text-center py-5" style="display: none;">
                    <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                    <p class="mt-3 text-muted">No ASN shipments found. Upload an ASN file to get started.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail View -->
    <div id="detailView" class="card" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> ASN Details</h5>
            <button type="button" class="btn btn-sm btn-primary" id="btnBackToList">
                <i class="bi bi-arrow-left"></i> Back to List
            </button>
        </div>
        <div class="card-body">
            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs mb-3" id="asnDetailTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="user-friendly-tab" data-bs-toggle="tab" data-bs-target="#user-friendly-content" type="button" role="tab">
                        <i class="bi bi-card-text"></i> User-Friendly View
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="raw-data-tab" data-bs-toggle="tab" data-bs-target="#raw-data-content" type="button" role="tab">
                        <i class="bi bi-code-square"></i> Raw Data
                    </button>
                </li>
                <li class="nav-item" role="presentation" id="chain-tab-item" style="display: none;">
                    <button class="nav-link" id="chain-tab" data-bs-toggle="tab" data-bs-target="#chain-content" type="button" role="tab">
                        <i class="bi bi-diagram-3"></i> Chain Visualization
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-content" type="button" role="tab">
                        <i class="bi bi-geo-alt"></i> Map View
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="visual-tab" data-bs-toggle="tab" data-bs-target="#visual-content" type="button" role="tab">
                        <i class="bi bi-diagram-2"></i> Visual View
                    </button>
                </li>
            </ul>

            <!-- Tabs Content -->
            <div class="tab-content" id="asnDetailTabContent">
                <!-- User-Friendly View Tab -->
                <div class="tab-pane fade show active" id="user-friendly-content" role="tabpanel">
                    <div id="shipmentDetails"></div>
                </div>

                <!-- Raw Data Tab -->
                <div class="tab-pane fade" id="raw-data-content" role="tabpanel">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6>Original ASN Data</h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyRawData()">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                        <pre id="rawDataContent" class="border rounded p-3" style="background-color: #f8f9fa; max-height: 600px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word;"></pre>
                    </div>
                </div>

                <!-- Chain Visualization Tab -->
                <div class="tab-pane fade" id="chain-content" role="tabpanel">
                    <div id="chainVisualization">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading chain...</span>
                            </div>
                            <p class="mt-2">Loading chain visualization...</p>
                        </div>
                    </div>
                </div>

                <!-- Map View Tab -->
                <div class="tab-pane fade" id="map-content" role="tabpanel">
                    <div id="mapViewContainer">
                        <div class="mb-3">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> <strong>Map View:</strong> Showing distribution routes and destinations
                            </div>
                        </div>
                        <div id="asnMap" style="height: 600px; width: 100%; border: 1px solid #dee2e6; border-radius: 4px;"></div>
                        <div id="mapWarnings" class="mt-3"></div>
                    </div>
                </div>

                <!-- Visual View Tab -->
                <div class="tab-pane fade" id="visual-content" role="tabpanel">
                    <div id="visualViewContainer">
                        <div class="mb-3">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> <strong>Visual View:</strong> Showing packaging flow from raw materials to distribution points
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" id="btnZoomFit">
                                        <i class="bi bi-arrows-angle-contract"></i> Fit to View
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="btnResetView">
                                        <i class="bi bi-arrow-clockwise"></i> Reset View
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="visualViewCanvas" style="position: relative; width: 100%; height: 700px; border: 1px solid #dee2e6; border-radius: 4px; background-color: #f5f5f5; overflow: auto;">
                            <div id="visualViewConnectionsLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                                <svg id="visualViewSvg" style="width: 100%; height: 100%;">
                                    <defs>
                                        <marker id="visualArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                            <path d="M0,0 L0,6 L9,3 z" fill="#6c757d" />
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            <div id="visualViewNodesLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;">
                            </div>
                        </div>
                        <div id="visualViewWarnings" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-in-transit { background-color: #cfe2ff; color: #084298; }
    .status-delivered { background-color: #d1e7dd; color: #0f5132; }
    .status-cancelled { background-color: #f8d7da; color: #842029; }

    .destination-badge {
        display: inline-block;
        padding: 4px 10px;
        margin: 2px;
        background-color: #e7f3ff;
        border-radius: 8px;
        font-size: 0.85rem;
    }

    .pallet-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f8f9fa;
    }

    /* Section headers (Shipper, Receiver, Transport) â€“ black text and icons for readability */
    .distribution-section-header,
    .distribution-section-header .bi,
    .distribution-section-header strong {
        color: #000 !important;
    }

    .pallet-card-compact .pallet-row-first {
        flex-wrap: nowrap;
    }
    .pallet-card-compact .pallet-row-first .col {
        min-width: 0;
    }

    .pallet-card-compact .pallet-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1rem 1.5rem;
        width: 100%;
    }

    .pallet-card-compact .pallet-col {
        flex: 0 0 auto;
    }

    .pallet-card-compact .pallet-col-actions {
        min-width: 200px;
    }

    .pallet-card-compact .pallet-col-sscc code.pallet-sscc {
        color: #c7254e;
        background-color: #f9f2f4;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 1em;
        font-weight: normal;
    }

    .pallet-card-compact .pallet-col-attrs {
        color: #6c757d;
        font-size: 0.95rem;
    }

    .pallet-card-compact .pallet-row-dest {
        width: 100%;
        margin-top: 0.5rem;
        padding-left: 0;
    }

    .pallet-card-compact .pallet-dest-block {
        display: block;
        text-align: left;
        word-wrap: break-word;
        white-space: normal;
    }

    .pallet-card-compact .pallet-col-dest {
        margin-left: auto;
        text-align: right;
        max-width: 320px;
    }

    .pallet-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
    }

    .product-detail-link {
        color: #0d6efd;
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
    }

    .product-detail-link:hover {
        text-decoration: underline;
        color: #0a58ca;
    }


    /* Keep distribution content below global navbar; match other pages (no extra background on header) */
    .distribution-page {
        position: relative;
        z-index: 1;
    }

    .line-item-row {
        padding: 8px;
        border-bottom: 1px solid #e9ecef;
    }
    .line-item-row:last-child {
        border-bottom: none;
    }

    .line-item-row .line-item-actions {
        text-align: right;
    }

    /* ASN list: no inner vertical scroll - table grows to show all rows, page scrolls */
    .distribution-asn-table-wrap {
        max-height: none !important;
        overflow-y: visible !important;
        overflow-x: auto;
    }
    #listView .card-body {
        overflow: visible !important;
    }

    /* Modal z-index, centering, and ensure forms are editable (not ghosted) */
    #uploadModal.modal .modal-dialog,
    #createAsnModal.modal .modal-dialog,
    #editPalletModal.modal .modal-dialog,
    #editLineItemModal.modal .modal-dialog {
        margin: 1.75rem auto;
    }

    #uploadModal .modal-body,
    #createAsnModal .modal-body,
    #editPalletModal .modal-body,
    #editLineItemModal .modal-body {
        max-height: min(70vh, 600px);
        overflow-y: auto;
    }

    .modal {
        z-index: 10500 !important;
    }

    .modal.show {
        opacity: 1 !important;
        pointer-events: auto !important;
    }

    .modal .modal-content {
        pointer-events: auto !important;
        opacity: 1 !important;
        background: #fff !important;
    }

    .modal .modal-body,
    .modal input,
    .modal select,
    .modal textarea,
    .modal .form-control,
    .modal label,
    .modal .form-check-input {
        pointer-events: auto !important;
        opacity: 1 !important;
    }

    .modal-backdrop {
        z-index: 10499 !important;
    }

    .modal-backdrop.show {
        opacity: 0.5 !important;
    }

    /* Visual Editor Node Styles for Visual View */
    .epr-canvas-node {
        position: absolute;
        min-width: 150px;
        padding: 1rem;
        background: white;
        border: 2px solid #28a745;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 10;
        transition: box-shadow 0.2s;
    }
    
    .epr-canvas-node:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .epr-node-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .epr-node-icon {
        font-size: 1.5rem;
        margin-right: 0.5rem;
    }
    
    .epr-node-title {
        font-weight: 600;
        font-size: 0.95rem;
        flex: 1;
    }
    
    .epr-node-type {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .epr-canvas-node[data-type="raw-material"] {
        border-color: #17a2b8;
    }
    
    .epr-canvas-node[data-type="packaging"] {
        border-color: #28a745;
    }
    
    .epr-canvas-node[data-type="product"] {
        border-color: #ffc107;
    }
    
    .epr-canvas-node[data-type="distribution"] {
        border-color: #6f42c1;
    }
    
    .epr-packaging-group-node {
        border-color: #17a2b8 !important;
        border-width: 3px !important;
        border-style: dashed !important;
        background: #f0f9ff !important;
        min-width: 200px !important;
        min-height: 120px !important;
        transition: all 0.2s ease;
        overflow: visible !important;
    }
    
    .epr-distribution-group-node {
        border-color: #6f42c1 !important;
        border-width: 3px !important;
        border-style: dashed !important;
        background: #f3e8ff !important;
        min-width: 200px !important;
        min-height: 120px !important;
        transition: all 0.2s ease;
        overflow: visible !important;
    }
    
    .epr-group-items-list {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #dee2e6;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .epr-group-item {
        transition: background-color 0.2s ease;
    }
    
    .epr-group-item:hover {
        background-color: #e9ecef !important;
    }
    
    .epr-group-packaging-item {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem 0;
        background: white;
        border-radius: 3px;
        border-left: 3px solid #007bff;
        cursor: pointer;
    }
    
    .epr-group-raw-material-item {
        font-size: 0.65rem;
        padding: 0.2rem 0.5rem 0.2rem 1.5rem;
        margin: 0.1rem 0;
        background: #f8f9fa;
        border-radius: 3px;
        border-left: 3px solid #6c757d;
        cursor: pointer;
    }
    
    .epr-group-distribution-item {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem 0;
        background: white;
        border-radius: 3px;
        border-left: 3px solid #6f42c1;
        cursor: pointer;
    }
    
    .epr-connection-port {
        position: absolute;
        width: 16px;
        height: 16px;
        border: 2px solid white;
        border-radius: 50%;
        cursor: crosshair;
        z-index: 10;
    }
    
    .epr-port-left {
        left: -8px;
        top: 50%;
        transform: translateY(-50%);
        background: #007bff;
    }
    
    .epr-port-right {
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
        background: #28a745;
    }
    
    .epr-connection-line {
        stroke: #6c757d;
        stroke-width: 2;
        fill: none;
        pointer-events: stroke;
    }
    
    .epr-connection-line:hover {
        stroke: #28a745;
        stroke-width: 3;
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script>
        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });
        
        // Copy raw data to clipboard
        function copyRawData() {
            const rawDataEl = document.getElementById('rawDataContent');
            if (rawDataEl) {
                navigator.clipboard.writeText(rawDataEl.textContent).then(() => {
                    alert('Raw data copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            }
        }
    </script>
}









