@{
    ViewData["Title"] = "Packaging Management";
    var type = ViewData["Type"] as string ?? "suppliers";
    var page = (int)(ViewData["Page"] ?? 1);
    var pageSize = (int)(ViewData["PageSize"] ?? 25);
    var sortBy = ViewData["SortBy"] as string ?? "name";
    var sortDir = ViewData["SortDir"] as string ?? "asc";
    var filter = ViewData["Filter"] as string ?? "";
}

<div class="container-fluid h-100 d-flex flex-column packaging-management-page" style="height: calc(100vh - 150px);">
    <!-- Header - z-index ensures tabs stay clickable above Visual Editor iframe -->
    <div id="packagingManagementHeader" class="d-flex justify-content-between align-items-center mb-3" style="position: relative; z-index: 100;">
        <div>
            <h2>
                <i class="bi bi-box-seam"></i> Packaging Management
            </h2>
            <ul class="nav nav-tabs" role="tablist" id="packagingManagementTabs">
                <li class="nav-item">
                    <a href="#" class="nav-link @(type == "suppliers" ? "active" : "")" data-type="suppliers" data-no-tab="true">
                        <i class="bi bi-truck"></i> Suppliers
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link @(type == "raw-materials" ? "active" : "")" data-type="raw-materials" data-no-tab="true">
                        <i class="bi bi-circle"></i> Raw Materials
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link @(type == "packaging-items" ? "active" : "")" data-type="packaging-items" data-no-tab="true">
                        <i class="bi bi-box-seam"></i> Packaging Items
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link @(type == "packaging-groups" ? "active" : "")" data-type="packaging-groups" data-no-tab="true">
                        <i class="bi bi-collection"></i> Packaging Groups
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link @(type == "packaging-taxonomy" ? "active" : "")" data-type="packaging-taxonomy" data-no-tab="true">
                        <i class="bi bi-diagram-2"></i> Packaging Taxonomy
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link @(type == "visual-editor" ? "active" : "")" data-type="visual-editor" data-no-tab="true">
                        <i class="bi bi-diagram-3"></i> Visual Editor
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link @(type == "supply-chain-matrix" ? "active" : "")" data-type="supply-chain-matrix" data-no-tab="true">
                        <i class="bi bi-grid-3x3"></i> Supply Chain Matrix
                    </a>
                </li>
            </ul>
        </div>
        <div id="packagingHeaderButtons" class="d-flex gap-2 @(type == "visual-editor" ? "d-none" : "")">
            <button id="addSupplierBtn" class="btn btn-primary @(type != "suppliers" ? "d-none" : "")" title="Add Packaging Supplier">
                <i class="bi bi-plus-lg"></i> Add Supplier
            </button>
            <button id="addRawMaterialBtn" class="btn btn-primary @(type != "raw-materials" ? "d-none" : "")" title="Add Raw Material">
                <i class="bi bi-plus-lg"></i> Add Raw Material
            </button>
            <button id="addPackagingItemBtn" class="btn btn-primary @(type != "packaging-items" ? "d-none" : "")" title="Add Packaging Item">
                <i class="bi bi-plus-lg"></i> Add Packaging Item
            </button>
            <button id="addPackagingGroupBtn" class="btn btn-primary @(type != "packaging-groups" ? "d-none" : "")" title="Add Packaging Group">
                <i class="bi bi-plus-lg"></i> Add Packaging Group
            </button>
            <button id="addMatrixRowBtn" class="btn btn-primary @(type != "supply-chain-matrix" ? "d-none" : "")" title="Add Row" onclick="window.openAddMatrixRowModal()">
                <i class="bi bi-plus-lg"></i> Add Row
            </button>
            <button id="exportMatrixCsvBtn" class="btn btn-outline-success @(type != "supply-chain-matrix" ? "d-none" : "")" title="Export CSV">
                <i class="bi bi-download"></i> Export CSV
            </button>
            <button id="toggleLayoutBtn" class="btn btn-outline-secondary" title="Switch to side-by-side layout" data-bs-toggle="tooltip" aria-label="Toggle layout">
                <i class="bi bi-arrows-expand" id="layoutIcon"></i>
            </button>
        </div>
    </div>

    <!-- Visual Editor (embedded when type=visual-editor) -->
    <div id="visualEditorContainer" class="flex-grow-1 @(type == "visual-editor" ? "" : "d-none")" style="min-height: 0; height: calc(100vh - 200px);">
        <iframe id="visualEditorFrame" src="@(type == "visual-editor" ? (Url.Action("Index", "VisualEditor") + "?embedded=1") : "")" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>

    <!-- Supply Chain Matrix Container -->
    <div id="matrixContainer" class="flex-grow-1 border rounded d-flex flex-column @(type == "supply-chain-matrix" ? "" : "d-none")" style="min-height: 0; overflow: hidden; background: #fff;">
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center flex-shrink-0 flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
                <h5 class="mb-0">Supply Chain Matrix</h5>
                <small class="text-muted">Full relational view of packaging supply chain</small>
            </div>
            <div class="d-flex gap-2 align-items-center flex-wrap">
                <div class="input-group input-group-sm" style="width: 220px;">
                    <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" id="matrixFilterInput" class="form-control form-control-sm" placeholder="Filter all columns..." aria-label="Filter matrix">
                </div>
                <div class="input-group input-group-sm" style="width: 180px;">
                    <label class="input-group-text bg-white" for="matrixGroupBy"><i class="bi bi-collection text-muted"></i></label>
                    <select id="matrixGroupBy" class="form-select form-select-sm">
                        <option value="group" selected>Group by Pack Group</option>
                        <option value="item">Group by Item</option>
                        <option value="material">Group by Material</option>
                        <option value="supplier">Group by Supplier</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="p-0 flex-grow-1" style="overflow: auto; min-height: 0;">
            <table class="table table-bordered table-hover mb-0" id="matrixTable" style="font-size: 0.875rem;">
                <thead class="table-light" id="matrixTableHead" style="position: sticky; top: 0; z-index: 2;">
                    <tr>
                        <th>Packaging Group</th>
                        <th>Packaging Item</th>
                        <th>Raw Material</th>
                        <th>Supplier</th>
                        <th>Upstream Supplier</th>
                        <th style="width: 80px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="matrixTableBody">
                    <tr><td colspan="6" class="text-center text-muted py-4">Loading matrix data...</td></tr>
                </tbody>
            </table>
        </div>
        <div class="p-3 border-top flex-shrink-0 d-flex justify-content-between align-items-center">
            <div><span id="matrixRecordCount">0</span> rows</div>
            <nav>
                <ul class="pagination pagination-sm mb-0" id="matrixPagination"></ul>
            </nav>
        </div>
    </div>

    <!-- Split Pane Container (table + detail) -->
    <div id="splitContainer" class="flex-grow-1 d-flex flex-column @(type == "visual-editor" ? "d-none" : "")" style="min-height: 0; --detail-pane-height: 40%; background: #fff;">
        <!-- Taxonomy Tree (packaging-taxonomy tab only) -->
        <div id="taxonomyTreeContainer" class="flex-grow-1 border rounded packaging-management-pane d-flex flex-column @(type == "packaging-taxonomy" ? "" : "d-none")" style="min-height: 0; overflow: hidden;">
            <div class="p-3 border-bottom packaging-pane-header flex-shrink-0">
                <h5 class="mb-0">Packaging Taxonomy</h5>
                <small class="text-muted d-block mt-1">Full hierarchy from raw materials to packaging groups</small>
                <div class="d-flex gap-2 mt-2 flex-wrap">
                    <div class="input-group input-group-sm" style="max-width: 220px;">
                        <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" id="taxonomyTreeSearch" class="form-control" placeholder="Search in tree..." aria-label="Search taxonomy">
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" id="taxonomyExpandAll" title="Expand all">Expand all</button>
                        <button type="button" class="btn btn-outline-secondary" id="taxonomyCollapseAll" title="Collapse all">Collapse all</button>
                    </div>
                </div>
            </div>
            <div id="taxonomyTreeContent" class="p-3" style="overflow-y: auto; overflow-x: hidden; min-height: 0; flex: 1;">
                <div class="text-muted text-center py-4">Loading taxonomy...</div>
            </div>
        </div>
        <!-- Top Pane: Table View -->
        <div id="tablePane" class="flex-grow-1 border rounded mb-2 packaging-management-pane d-flex flex-column @(type == "packaging-taxonomy" ? "d-none" : "")" style="min-height: 750px; overflow: hidden; flex: 1 1 0;">
            <div class="p-3 border-bottom packaging-pane-header flex-shrink-0">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" id="tablePaneTitle">@(type == "suppliers" ? "Supplier List" : "Summary Table")</h5>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <div class="input-group input-group-sm" style="width: 220px;">
                            <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                            <input type="text" id="filterInput" class="form-control form-control-sm" placeholder="Filter by name, code..." value="@filter" aria-label="Filter records">
                        </div>
                        <div id="filterBadge" class="d-none align-items-center gap-1">
                            <span class="badge bg-primary">Filter: <span id="filterBadgeText"></span></span>
                            <button id="clearFilterBadgeBtn" class="btn btn-sm btn-outline-secondary py-0 px-1" title="Clear filter"><i class="bi bi-x"></i></button>
                        </div>
                        <button id="clearFilterBtn" class="btn btn-sm btn-outline-secondary" title="Clear filter" aria-label="Clear filter">
                            <i class="bi bi-x"></i>
                        </button>
                        <div class="btn-group btn-group-sm ms-1" role="group" aria-label="View mode">
                            <button type="button" class="btn btn-outline-secondary active" id="tableViewBtn" title="Table view" aria-label="Table view" aria-pressed="true"><i class="bi bi-table"></i></button>
                            <button type="button" class="btn btn-outline-secondary" id="cardViewBtn" title="Card view" aria-label="Card view" aria-pressed="false"><i class="bi bi-grid-3x3-gap"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-3 packaging-table-content" style="min-height: 625px; flex: 1; overflow-y: auto; overflow-x: hidden;">
                <table class="table table-hover table-striped" id="dataTable" role="grid">
                    <thead id="tableHead">
                        <tr>
                            <!-- Headers will be populated by JavaScript -->
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="100%" class="text-center py-4">
                                <div class="skeleton skeleton-text short mx-auto mb-2"></div>
                                <div class="skeleton skeleton-text medium mx-auto mb-2"></div>
                                <div class="skeleton skeleton-text long mx-auto" style="width:40%;"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div id="cardViewContainer" class="table-card-view d-none"></div>
            </div>
            <div class="p-3 border-top packaging-pane-header flex-shrink-0">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span id="recordCount">0</span> records
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination">
                            <!-- Pagination will be populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Resize handle between table and detail -->
        <div id="splitResizeHandle" class="packaging-resize-handle @(type == "packaging-taxonomy" ? "d-none" : "")" title="Drag to resize" aria-label="Resize panes"></div>
        <!-- Bottom Pane: Detail View -->
        <div id="detailPane" class="border rounded packaging-management-pane d-flex flex-column @(type == "packaging-taxonomy" ? "d-none" : "")" style="flex: 0 0 40%; min-height: 200px; overflow: hidden;" data-detail-height="40">
            <div class="p-3 border-bottom packaging-pane-header d-flex justify-content-between align-items-center flex-shrink-0">
                <div class="d-flex align-items-center gap-2 flex-grow-1 min-w-0">
                    <button id="detailPaneToggleBtn" type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" title="Collapse detail pane" aria-label="Collapse detail pane">
                        <i class="bi bi-chevron-down" id="detailPaneToggleIcon"></i>
                    </button>
                    <button id="detailBackBtn" type="button" class="btn btn-sm btn-outline-secondary py-0 px-1 d-none" title="Back" aria-label="Back to previous"><i class="bi bi-arrow-left"></i></button>
                    <button id="mobileBackToListBtn" type="button" class="btn btn-sm btn-outline-secondary py-0 px-1 packaging-mobile-back-btn" title="Back to list" aria-label="Back to list"><i class="bi bi-arrow-left"></i> Back</button>
                    <div class="d-flex align-items-center gap-1 min-w-0" id="detailBreadcrumb">
                        <h5 class="mb-0 text-truncate" id="detailPaneTitle">@(type == "suppliers" ? "Packaging Supplier" : type == "raw-materials" ? "Raw Material" : type == "packaging-items" ? "Packaging Item" : type == "packaging-groups" ? "Packaging Group" : "Record Details")</h5>
                    </div>
                </div>
                <div class="d-flex gap-1 align-items-center">
                    <button id="editRecordBtn" class="btn btn-outline-primary btn-sm d-none" title="Edit" aria-label="Edit record"><i class="bi bi-pencil"></i> Edit</button>
                    <button id="deleteRecordBtn" class="btn btn-outline-danger btn-sm d-none" title="Delete" aria-label="Delete record"><i class="bi bi-trash"></i> Delete</button>
                    <button id="addProductBtn" class="btn btn-success btn-sm @(type != "suppliers" ? "d-none" : "")" title="Add Product" disabled aria-label="Add product to supplier">
                    <i class="bi bi-plus-lg"></i> Add Product
                </button>
                </div>
            </div>
            <div class="detail-pane-body p-3" style="min-height: 0; flex: 1; overflow-y: auto; overflow-x: hidden;">
                <div id="detailContent" class="text-muted text-center packaging-detail-empty">
                    <p class="mb-2">Select a record from the table to view details</p>
                    <small>Or use the Add button above to create a new record</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage" class="mb-0">Are you sure you want to delete this record?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteConfirmBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Supplier Modal (multi-step) -->
<div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSupplierModalLabel">Add Packaging Supplier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="supplier-modal-steps mb-3">
                    <div class="supplier-step-indicator d-flex align-items-center justify-content-center gap-2">
                        <span class="supplier-step-badge active" data-step="1" aria-current="step">1. Company</span>
                        <span class="supplier-step-arrow">â†’</span>
                        <span class="supplier-step-badge" data-step="2">2. Contacts</span>
                    </div>
                </div>
                <div id="supplierStep1" class="supplier-step-content">
                    <div class="row g-2">
                        <div class="col-12">
                            <label class="form-label" for="supplierName">Name *</label>
                            <input type="text" id="supplierName" class="form-control" required placeholder="Company name" aria-required="true">
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="supplierAddress">Street Address</label>
                            <input type="text" id="supplierAddress" class="form-control" placeholder="Street address">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="supplierCity">City</label>
                            <input type="text" id="supplierCity" class="form-control" placeholder="City">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="supplierState">State / Province</label>
                            <input type="text" id="supplierState" class="form-control" placeholder="State">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="supplierCountry">Country</label>
                            <input type="text" id="supplierCountry" class="form-control" placeholder="Country">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="supplierPhone">Phone</label>
                            <input type="text" id="supplierPhone" class="form-control" placeholder="+44 ...">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="supplierEmail">Email</label>
                            <input type="email" id="supplierEmail" class="form-control" placeholder="sales@company.com">
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="supplierWebsite">Website</label>
                            <input type="url" id="supplierWebsite" class="form-control" placeholder="https://...">
                        </div>
                    </div>
                </div>
                <div id="supplierStep2" class="supplier-step-content d-none">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">Contact Persons</label>
                        <button type="button" class="btn btn-secondary btn-sm" id="addContactRowBtn" aria-label="Add contact person">
                            <i class="bi bi-plus-lg"></i> Add Contact
                        </button>
                    </div>
                    <div id="contactRowsContainer">
                        <div class="contact-row border rounded p-2 mb-2 bg-light d-flex align-items-center">
                            <div class="row g-2 flex-grow-1">
                                <div class="col-md-4"><input type="text" class="form-control form-control-sm contact-name" placeholder="Name" aria-label="Contact name"></div>
                                <div class="col-md-3"><input type="text" class="form-control form-control-sm contact-title" placeholder="Title" aria-label="Contact title"></div>
                                <div class="col-md-3"><input type="text" class="form-control form-control-sm contact-phone" placeholder="Phone" aria-label="Contact phone"></div>
                                <div class="col-md-2"><input type="email" class="form-control form-control-sm contact-email" placeholder="Email" aria-label="Contact email"></div>
                            </div>
                            <button type="button" class="btn btn-outline-danger btn-sm ms-2 remove-contact-btn" title="Remove contact" aria-label="Remove contact"><i class="bi bi-x-lg"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" id="supplierStepPrevBtn" style="display:none;">â† Back</button>
                <button type="button" class="btn btn-outline-primary" id="supplierStepNextBtn">Next â†’</button>
                <button type="button" class="btn btn-primary" id="saveSupplierBtn" style="display:none;">Save Supplier</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Raw Material Modal -->
<div class="modal fade" id="addRawMaterialModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Raw Material</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2">
                    <div class="col-12">
                        <label class="form-label">Name *</label>
                        <input type="text" id="rawMaterialName" class="form-control" required placeholder="e.g. High-Density Polyethylene">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="rawMaterialCode">Code *</label>
                        <input type="text" id="rawMaterialCode" class="form-control" required placeholder="e.g. HDPE">
                        <small class="form-text text-muted">Short identifier used in taxonomy (e.g. PET, HDPE, PAP)</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Level</label>
                        <select id="rawMaterialLevel" class="form-select">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Parent (optional)</label>
                        <select id="rawMaterialParent" class="form-select">
                            <option value="">â€” None (top level) â€”</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <textarea id="rawMaterialDescription" class="form-control" rows="2" placeholder="Description"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRawMaterialBtn">Save Raw Material</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Packaging Item Modal -->
<div class="modal fade" id="addPackagingItemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Packaging Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2">
                    <div class="col-12">
                        <label class="form-label">Name *</label>
                        <input type="text" id="packagingItemName" class="form-control" required placeholder="e.g. HDPE Cap 28mm">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="packagingItemTaxonomyCode">Taxonomy Code *</label>
                        <input type="text" id="packagingItemTaxonomyCode" class="form-control" required placeholder="e.g. HDPE.CAP.28">
                        <small class="form-text text-muted">Format: Material.Type.Size (e.g. PET.CAP.28, HDPE.BOTTLE.500)</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Weight (g)</label>
                        <input type="number" id="packagingItemWeight" class="form-control" step="0.01" min="0" placeholder="Optional">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Raw Materials</label>
                        <select id="packagingItemRawMaterials" class="form-select" multiple size="4">
                        </select>
                        <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Supplier Products (optional)</label>
                        <select id="packagingItemSuppliers" class="form-select" multiple size="3">
                        </select>
                        <small class="text-muted">Link to supplier products for supply chain</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePackagingItemBtn">Save Packaging Item</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Packaging Group Modal -->
<div class="modal fade" id="addPackagingGroupModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Packaging Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2">
                    <div class="col-12">
                        <label class="form-label">Name *</label>
                        <input type="text" id="packagingGroupName" class="form-control" required placeholder="e.g. Bottle + Cap + Label">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="packagingGroupPackId">Pack ID *</label>
                        <input type="text" id="packagingGroupPackId" class="form-control" required placeholder="e.g. BTL-CAP-LBL-001">
                        <small class="form-text text-muted">Unique identifier for the pack (e.g. BTL-CAP-LBL-001)</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Packaging Layer</label>
                        <input type="text" id="packagingGroupLayer" class="form-control" placeholder="e.g. Primary">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Packaging Items</label>
                        <select id="packagingGroupItems" class="form-select" multiple size="6">
                        </select>
                        <small class="text-muted">Hold Ctrl/Cmd to select multiple. Order determines display.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePackagingGroupBtn">Save Packaging Group</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Packaging Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Packaging</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small" id="addProductSupplierName"></p>
                <div class="mb-2">
                    <label class="form-label">Product Name *</label>
                    <input type="text" id="productName" class="form-control" required placeholder="Product name">
                </div>
                <div class="mb-2">
                    <label class="form-label">Description</label>
                    <textarea id="productDescription" class="form-control" rows="2" placeholder="Product description"></textarea>
                </div>
                <div class="mb-2">
                    <label class="form-label">Product Code</label>
                    <input type="text" id="productCode" class="form-control" placeholder="SKU or product code">
                </div>
                <div class="mb-2">
                    <label class="form-label" for="productTaxonomyCode">Taxonomy Code</label>
                    <input type="text" id="productTaxonomyCode" class="form-control" placeholder="e.g. PET, HDPE, PAP">
                    <small class="form-text text-muted">Material type (e.g. PET, HDPE, PAP)</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProductBtn">Save Packaging</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Matrix Row Modal -->
<div class="modal fade" id="addMatrixRowModal" tabindex="-1" aria-labelledby="addMatrixRowModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMatrixRowModalLabel"><i class="bi bi-plus-circle me-2"></i>Add Supply Chain Row</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="addMatrixRowAlert" class="alert d-none mb-3"></div>
                <div class="row g-3">
                    <!-- Packaging Group -->
                    <div class="col-12">
                        <label class="form-label fw-semibold">Packaging Group</label>
                        <select id="matrixRowGroup" class="form-select">
                            <option value="">(None / Ungrouped)</option>
                            <option value="__new__">-- Create New Group --</option>
                        </select>
                        <div id="matrixRowNewGroupFields" class="d-none mt-2 p-2 border rounded bg-light">
                            <div class="row g-2">
                                <div class="col-md-5"><input type="text" class="form-control form-control-sm" id="matrixRowNewGroupName" placeholder="Group name *"></div>
                                <div class="col-md-4"><input type="text" class="form-control form-control-sm" id="matrixRowNewGroupPackId" placeholder="Pack ID"></div>
                                <div class="col-md-3"><input type="text" class="form-control form-control-sm" id="matrixRowNewGroupLayer" placeholder="Layer"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Packaging Item -->
                    <div class="col-12">
                        <label class="form-label fw-semibold">Packaging Item <span class="text-danger">*</span></label>
                        <select id="matrixRowItem" class="form-select">
                            <option value="">-- Select Item --</option>
                            <option value="__new__">-- Create New Item --</option>
                        </select>
                        <div id="matrixRowNewItemFields" class="d-none mt-2 p-2 border rounded bg-light">
                            <div class="row g-2">
                                <div class="col-md-5"><input type="text" class="form-control form-control-sm" id="matrixRowNewItemName" placeholder="Item name *"></div>
                                <div class="col-md-4"><input type="text" class="form-control form-control-sm" id="matrixRowNewItemCode" placeholder="Taxonomy code"></div>
                                <div class="col-md-3"><input type="number" step="0.01" class="form-control form-control-sm" id="matrixRowNewItemWeight" placeholder="Weight (g)"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Raw Materials (multi) -->
                    <div class="col-12">
                        <label class="form-label fw-semibold">Raw Materials</label>
                        <select id="matrixRowMaterials" class="form-select" multiple size="4">
                        </select>
                        <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    <!-- Supplier Products (multi) -->
                    <div class="col-12">
                        <label class="form-label fw-semibold">Supplier Products</label>
                        <select id="matrixRowSupplierProducts" class="form-select" multiple size="4">
                        </select>
                        <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMatrixRowBtn" onclick="window.saveMatrixRow()">
                    <span class="spinner-border spinner-border-sm d-none me-1" id="saveMatrixRowSpinner"></span>Save Row
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Product Associations Modal -->
<div class="modal fade" id="productAssociationsModal" tabindex="-1" aria-labelledby="productAssociationsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productAssociationsModalLabel"><i class="bi bi-box-seam me-2"></i>Product Associations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3" id="productAssocContext"></p>
                <div id="productAssocLoading" class="text-center py-3 d-none">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Loading product associations...</p>
                </div>
                <div id="productAssocEmpty" class="text-center py-3 d-none">
                    <i class="bi bi-info-circle fs-3 text-muted"></i>
                    <p class="mt-2 text-muted">No products are associated with this supply chain path.</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover d-none" id="productAssocTable">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>SKU</th>
                                <th>Brand</th>
                                <th>Category</th>
                            </tr>
                        </thead>
                        <tbody id="productAssocTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .split-horizontal {
            flex-direction: row !important;
        }
        
        .split-horizontal #tablePane {
            width: 60%;
            margin-right: 0;
            margin-bottom: 0;
        }
        .split-horizontal #splitResizeHandle {
            width: 6px;
            height: auto;
            cursor: col-resize;
            flex: 0 0 6px;
        }
        .split-horizontal #splitResizeHandle::after {
            width: 2px;
            height: 20%;
            margin: 40% 2px;
        }
        .split-horizontal #detailPane {
            width: 40%;
            height: 100% !important;
            flex: 1 1 auto !important;
        }
        
        .supplier-step-badge { padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; background: #e9ecef; color: #6c757d; }
        .supplier-step-badge.active { background: #0d6efd; color: #fff; }
        .supplier-step-arrow { color: #adb5bd; font-size: 0.75rem; }
        .form-text.text-muted { font-size: 0.8rem; margin-top: 0.15rem; }
        
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        
        .sortable:hover {
            background-color: #f8f9fa;
        }
        
        .sort-asc::after {
            content: "";
            display: inline-block;
            margin-left: 0.25rem;
            width: 0; height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 5px solid currentColor;
        }
        
        .sort-desc::after {
            content: "";
            display: inline-block;
            margin-left: 0.25rem;
            width: 0; height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 5px solid currentColor;
        }
        
        .table tbody tr {
            cursor: pointer;
            transition: box-shadow 0.15s ease, background-color 0.15s ease;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        }
        
        .table tbody tr.selected {
            background-color: #e7f3ff;
        }
        
        .detail-section {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        .detail-section h6 {
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.5rem;
            margin-bottom: 0.75rem;
            text-align: left;
        }
        
        .detail-item {
            margin-bottom: 0.5rem;
        }
        
        .detail-label {
            font-weight: 600;
            color: #6c757d;
            display: inline-block;
            width: 150px;
        }
        
        .relationship-badge {
            display: inline-block;
            margin: 0.25rem;
            padding: 0.25rem 0.5rem;
            background-color: #e9ecef;
            border-radius: 0.25rem;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            transition: background-color 0.15s;
        }
        
        .relationship-badge:hover {
            background-color: #0d6efd;
            color: #fff;
        }
        
        .relationship-badge[data-nav-id] {
            text-decoration: none;
        }
        
        .child-row {
            background-color: #f8f9fa !important;
        }
        
        .child-row:hover {
            background-color: #e9ecef !important;
        }
        
        .child-row td {
            border-left: 3px solid #6c757d;
        }
        
        .nav-tabs .nav-link {
            color: #495057;
            border: 1px solid transparent;
            border-radius: 0.25rem 0.25rem 0 0;
        }
        .nav-tabs .nav-link:hover {
            border-color: #e9ecef #e9ecef #dee2e6;
            color: #0d6efd;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
            font-weight: 500;
        }
        
        .supplier-detail-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .supplier-detail-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: #212529;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        .supplier-contact-card {
            background: #f8f9fa;
            border-radius: 0.25rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
        }
        .supplier-products-nested {
            margin-left: 1rem;
            padding-left: 1rem;
            border-left: 3px solid #0d6efd;
        }
        .supply-chain-lineal {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .supply-chain-item {
            padding: 0.5rem 0.75rem;
            background: #f8f9fa;
            border-radius: 0.25rem;
            border-left: 3px solid #6c757d;
        }
        .supply-chain-flow {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        .supply-chain-step {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .supply-chain-step.product { background: #e7f3ff; color: #0d6efd; font-weight: 600; }
        .supply-chain-step.supplier { background: #cfe2ff; color: #084298; }
        .supply-chain-step.upstream { background: #d1e7dd; color: #0f5132; }
        .supply-chain-arrow { color: #6c757d; font-size: 0.75rem; margin: 0 0.15rem; }
        .supply-chain-product { font-weight: 600; }
        .supply-chain-supplier { color: #0d6efd; }
        .supply-chain-upstream { color: #198754; }
        .supply-chain-cell { font-size: 0.85em; color: #6c757d; }
        /* Taxonomy tree - file explorer style */
        .taxonomy-tree { list-style: none; padding-left: 0; margin: 0; font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, Consolas, monospace; font-size: 0.9rem; }
        .taxonomy-tree ul { list-style: none; padding-left: 1.5rem; margin: 0; position: relative; }
        .taxonomy-tree ul::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 1px; background: #2d6a4f; }
        .taxonomy-tree li { position: relative; margin: 0; }
        .taxonomy-tree li::before { content: ''; position: absolute; left: -1.5rem; top: 0.75em; width: 1rem; height: 1px; background: #2d6a4f; }
        .taxonomy-tree .tree-node { display: flex; align-items: center; gap: 0.4rem; padding: 0.25rem 0.4rem; cursor: pointer; color: #212529; }
        .taxonomy-tree .tree-node:hover { background-color: #f1f3f4; }
        .taxonomy-tree .tree-node .tree-toggle { width: 1rem; text-align: center; color: #495057; user-select: none; font-size: 0.7rem; }
        .taxonomy-tree .tree-node .tree-toggle.empty { visibility: hidden; width: 1rem; }
        .taxonomy-tree .tree-node .tree-icon { font-size: 1rem; flex-shrink: 0; }
        .taxonomy-tree .tree-node.raw-material .tree-icon { color: #2d6a4f; }
        .taxonomy-tree .tree-node.packaging-item .tree-icon { color: #1b4332; }
        .taxonomy-tree .tree-node.packaging-group .tree-icon { color: #40916c; }
        .taxonomy-tree .tree-node.folder .tree-icon { color: #2d6a4f; }
        .taxonomy-tree .tree-node .tree-label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .taxonomy-tree .tree-node .tree-badge { font-size: 0.75rem; color: #6c757d; flex-shrink: 0; }
        /* Packaging page - white throughout for visual continuity */
        .packaging-management-page { background-color: #fff; }
        .packaging-management-pane { background-color: #fff; }
        .packaging-pane-header { background-color: #fff; border-color: #dee2e6; }
        .packaging-detail-empty { padding: 2rem 1rem; }
        /* Hide scrollbars on table/detail panes; content still scrollable via mouse/touch */
        .packaging-table-content,
        .detail-pane-body { overflow-x: hidden; scrollbar-width: none; -ms-overflow-style: none; }
        .packaging-table-content::-webkit-scrollbar,
        .detail-pane-body::-webkit-scrollbar { display: none; }
        .packaging-resize-handle {
            height: 6px;
            cursor: row-resize;
            background: var(--border-color);
            flex-shrink: 0;
            transition: background 0.15s;
        }
        .packaging-resize-handle:hover { background: var(--primary-color); }
        .packaging-resize-handle::after {
            content: '';
            display: block;
            height: 2px;
            margin: 2px 20%;
            background: #adb5bd;
            border-radius: 1px;
        }
        #detailPane.collapsed { flex: 0 0 auto !important; min-height: 0 !important; }
        #detailPane.collapsed .detail-pane-body { display: none !important; }
        #detailPane.collapsed .packaging-pane-header { margin-bottom: 0; }
        
        /* Table polish - truncation with tooltip */
        .table td.text-truncate-cell { max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* Card view */
        .table-card-view { display: none; }
        .table-card-view .table-card { border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: box-shadow 0.15s, border-color 0.15s; }
        .table-card-view .table-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.08); border-color: #0d6efd; }
        .table-card-view .table-card.selected { border-color: #0d6efd; background: #e7f3ff; }
        .table-card-view .table-card-title { font-weight: 600; margin-bottom: 0.5rem; }
        .table-card-view .table-card-meta { font-size: 0.875rem; color: #6c757d; }
        
        /* Loading skeletons */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: skeleton-pulse 1.5s ease-in-out infinite; border-radius: 0.25rem; }
        .skeleton-text { height: 1rem; margin-bottom: 0.5rem; }
        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.long { width: 100%; }
        @@keyframes skeleton-pulse { 0%, 100% { background-position: 200% 0; } 50% { background-position: -200% 0; } }
        
        /* Responsive - viewport < 992px */
        @@media (max-width: 991.98px) {
            .split-horizontal { flex-direction: column !important; }
            .split-horizontal #tablePane, .split-horizontal #detailPane { width: 100% !important; }
            #splitContainer.packaging-mobile-detail-open #tablePane { display: none !important; }
            #splitContainer.packaging-mobile-detail-open #detailPane { display: block !important; flex: 1 1 auto !important; }
            #splitContainer.packaging-mobile-detail-open #splitResizeHandle { display: none !important; }
            .packaging-mobile-back-btn { display: inline-flex !important; }
        }
        .packaging-mobile-back-btn { display: none; }

        /* Supply Chain Matrix styles */
        #matrixTable { border-collapse: collapse; }
        #matrixTable thead th {
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: #495057;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
            padding: 0.6rem 0.75rem;
        }
        #matrixTable tbody td {
            vertical-align: middle;
            padding: 0.5rem 0.75rem;
            position: relative;
        }
        .matrix-group-header td {
            background: #e9ecef !important;
            font-weight: 600;
            border-top: 2px solid #ced4da !important;
        }
        .matrix-group-even td { background-color: #fff; }
        .matrix-group-odd td { background-color: #fafbfc; }
        .matrix-cell-merged {
            color: transparent;
            user-select: none;
        }
        .matrix-cell-merged::after { content: none; }
        .matrix-cell-first {
            font-weight: 600;
            color: #212529;
        }
        .matrix-cell-missing {
            background-color: #fff8e1 !important;
        }
        .matrix-assign-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: #e6a100;
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.15s;
        }
        .matrix-assign-link:hover { color: #b57d00; text-decoration: underline; }
        .matrix-action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: #fff;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.85rem;
            padding: 0;
            vertical-align: middle;
        }
        .matrix-action-btn:hover { border-color: #0d6efd; color: #0d6efd; background: #e7f3ff; }
        .matrix-action-btn.danger { color: #adb5bd; }
        .matrix-action-btn.danger:hover { border-color: #dc3545; color: #dc3545; background: #fff5f5; }
        .matrix-plus-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border: 1px dashed #adb5bd;
            border-radius: 50%;
            background: transparent;
            color: #adb5bd;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.7rem;
            padding: 0;
            vertical-align: middle;
            margin-left: 4px;
        }
        .matrix-plus-btn:hover { border-color: #198754; color: #198754; background: #d1e7dd; border-style: solid; }
        .matrix-inline-select {
            font-size: 0.8rem;
            padding: 0.15rem 0.35rem;
            border: 1px solid #0d6efd;
            border-radius: 4px;
            outline: none;
            max-width: 180px;
        }
        .matrix-flash-success { animation: matrixFlashGreen 0.6s ease; }
        .matrix-flash-error { animation: matrixFlashRed 0.6s ease; }
        @@keyframes matrixFlashGreen { 0% { background-color: #d4edda; } 100% { background-color: inherit; } }
        @@keyframes matrixFlashRed { 0% { background-color: #f8d7da; } 100% { background-color: inherit; } }
        .matrix-nav-link {
            color: #0d6efd;
            cursor: pointer;
            text-decoration: none;
        }
        .matrix-nav-link:hover { text-decoration: underline; }
    </style>
}

@section Scripts {
    @* PACKAGING_INIT and packaging-management.js are loaded in _Layout when controller is PackagingManagement *@
}
