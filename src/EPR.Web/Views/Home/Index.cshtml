@{
    ViewData["Title"] = "Home";
    var datasetKey = ViewBag.DatasetKey as string;
    var hasDataset = !string.IsNullOrEmpty(datasetKey);
    var totalProducts = ViewBag.TotalProducts as int? ?? 0;
    var productsByType = ViewBag.ProductsByType as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var packagingByWeight = ViewBag.PackagingByWeight as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var distributionCount = ViewBag.DistributionCount as int? ?? 0;
}

<!-- Dataset Selection (shown when no dataset loaded) -->
<div id="datasetSelectionSection" class="container-fluid home-page dataset-selection-page" style="@(hasDataset ? "display: none;" : "")">
    <h2 class="dataset-selection-heading mb-4"><i class="bi bi-database"></i> Select a Dataset</h2>
    <div class="dataset-grid">
        <button type="button" class="dataset-card" data-dataset="Alcoholic Beverages" data-phrase="Loading the drinks..." data-icon="bi-cup-straw">
            <div class="dataset-card-icon"><i class="bi bi-cup-straw"></i></div>
            <div class="dataset-card-title">Alcoholic Beverages</div>
            <div class="dataset-card-count">20 products</div>
        </button>
        <button type="button" class="dataset-card" data-dataset="Confectionary" data-phrase="Unwrapping the sweets..." data-icon="bi-gift">
            <div class="dataset-card-icon"><i class="bi bi-gift"></i></div>
            <div class="dataset-card-title">Confectionary</div>
            <div class="dataset-card-count">20 products</div>
        </button>
        <button type="button" class="dataset-card" data-dataset="Electronics" data-phrase="Charging up the gadgets..." data-icon="bi-cpu">
            <div class="dataset-card-icon"><i class="bi bi-cpu"></i></div>
            <div class="dataset-card-title">Electronics</div>
            <div class="dataset-card-count">20 products</div>
        </button>
        <button type="button" class="dataset-card" data-dataset="Fresh Produce" data-phrase="Picking the freshest..." data-icon="bi-apple">
            <div class="dataset-card-icon"><i class="bi bi-apple"></i></div>
            <div class="dataset-card-title">Fresh Produce</div>
            <div class="dataset-card-count">20 products</div>
        </button>
        <button type="button" class="dataset-card" data-dataset="Garden" data-phrase="Growing the garden..." data-icon="bi-flower2">
            <div class="dataset-card-icon"><i class="bi bi-flower2"></i></div>
            <div class="dataset-card-title">Garden</div>
            <div class="dataset-card-count">20 products</div>
        </button>
        <button type="button" class="dataset-card" data-dataset="Homewares" data-phrase="Arranging the home..." data-icon="bi-house-door">
            <div class="dataset-card-icon"><i class="bi bi-house-door"></i></div>
            <div class="dataset-card-title">Homewares</div>
            <div class="dataset-card-count">20 products</div>
        </button>
        <button type="button" class="dataset-card" data-dataset="Personal Care" data-phrase="Preparing your routine..." data-icon="bi-person-hearts">
            <div class="dataset-card-icon"><i class="bi bi-person-hearts"></i></div>
            <div class="dataset-card-title">Personal Care</div>
            <div class="dataset-card-count">2,341 records</div>
        </button>
        <button type="button" class="dataset-card" data-dataset="Pet Care" data-phrase="Fetching pet supplies..." data-icon="bi-heart-pulse">
            <div class="dataset-card-icon"><i class="bi bi-heart-pulse"></i></div>
            <div class="dataset-card-title">Pet Care</div>
            <div class="dataset-card-count">678 records</div>
        </button>
        <button type="button" class="dataset-card" data-dataset="Pharmaceuticals" data-phrase="Dispensing the medicine..." data-icon="bi-capsule">
            <div class="dataset-card-icon"><i class="bi bi-capsule"></i></div>
            <div class="dataset-card-title">Pharmaceuticals</div>
            <div class="dataset-card-count">1,902 records</div>
        </button>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="datasetLoadingModal" tabindex="-1" aria-labelledby="datasetLoadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5 px-4">
                <div class="dataset-loading-phrase mb-3" id="datasetLoadingPhrase">Loading...</div>
                <div class="progress" style="height: 12px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="datasetLoadingProgress" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Dashboard (shown after dataset loaded) -->
<div id="mainDashboardSection" class="container-fluid home-page" style="@(hasDataset ? "" : "display: none;")">
    <div class="home-grid">
        <a href="@Url.Action("Index", "PackagingManagement")" class="home-card" onclick="if(window.browserTabs) { window.browserTabs.addTab('@Url.Action("Index", "PackagingManagement")', 'Packaging', 'bi-box-seam', 'Packaging'); return false; }">
            <div class="home-card-icon"><i class="bi bi-box-seam" style="font-size: 3rem;"></i></div>
            <h3 class="home-card-title">Packaging</h3>
            <p class="home-card-description">Manage raw materials, packaging items, and packaging groups in one place</p>
        </a>

        <a href="@Url.Action("Index", "Products")" class="home-card" onclick="if(window.browserTabs) { window.browserTabs.addTab('@Url.Action("Index", "Products")', 'Products', 'bi-bag', 'Products'); return false; }">
            <div class="home-card-icon"><i class="bi bi-bag" style="font-size: 3rem;"></i></div>
            <h3 class="home-card-title">Products</h3>
            <p class="home-card-description">Manage product SKUs and associate packaging units</p>
        </a>

        <a href="/distribution" class="home-card" onclick="if(window.browserTabs) { window.browserTabs.addTab('/distribution', 'Distribution', 'bi-truck', 'Distribution'); return false; }">
            <div class="home-card-icon"><i class="bi bi-truck" style="font-size: 3rem;"></i></div>
            <h3 class="home-card-title">Distribution</h3>
            <p class="home-card-description">Track product distribution to locations and geographies</p>
        </a>

        <a href="@Url.Action("Dashboard", "Reporting")" class="home-card" data-no-tab="true">
            <div class="home-card-icon"><i class="bi bi-graph-up-arrow" style="font-size: 3rem;"></i></div>
            <h3 class="home-card-title">Reporting</h3>
            <p class="home-card-description">View comprehensive reports, charts, and analytics for packaging and products</p>
        </a>
    </div>

    <!-- Dashboard Overview -->
    <div class="dashboard-overview-section mt-5">
        <div class="dashboard-overview-header mb-4">
            <h2 class="mb-1" style="font-size: 1.5rem; color: var(--dark-text);"><i class="bi bi-graph-up"></i> <span data-translate="Dashboard Overview">Dashboard Overview</span></h2>
            <p class="text-muted mb-0 small"><span data-translate="Key statistics from your packaging and product data">Key statistics from your packaging and product data</span></p>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">@totalProducts</div>
                        <div class="stat-label text-muted small text-uppercase"><span data-translate="Total Products">Total Products</span></div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">@(productsByType?.Count() ?? 0)</div>
                        <div class="stat-label text-muted small text-uppercase"><span data-translate="Product Categories">Product Categories</span></div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">@(packagingByWeight?.Count() ?? 0)</div>
                        <div class="stat-label text-muted small text-uppercase"><span data-translate="Packaging Types">Packaging Types</span></div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">@distributionCount</div>
                        <div class="stat-label text-muted small text-uppercase"><span data-translate="Distribution Records">Distribution Records</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 home-dashboard-tables">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header"><i class="bi bi-pie-chart"></i> <span data-translate="Products by Type">Products by Type</span></div>
                    <div class="card-body">
                        @if (productsByType != null && productsByType.Any())
                        {
                            var maxCat = 0;
                            foreach (var i in productsByType) { var c = (int)i.Count; if (c > maxCat) { maxCat = c; } }
                            if (maxCat == 0) { maxCat = 1; }
                            foreach (var item in productsByType)
                            {
                                var count = (int)item.Count;
                                var pct = maxCat > 0 ? (count * 100.0 / maxCat) : 0;
                                <div class="d-flex justify-content-between align-items-center mb-2 home-overview-row">
                                    <div class="flex-grow-1 me-2">
                                        <div class="home-overview-label">@item.Type</div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar" role="progressbar" style="width: @pct.ToString("F0")%; background: var(--primary-color);"></div>
                                        </div>
                                    </div>
                                    <span class="home-overview-value">@count</span>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted text-center py-3 mb-0 small"><span data-translate="No product type data">No product type data</span></p>
                        }
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header"><i class="bi bi-bar-chart"></i> <span data-translate="Packaging Type by Weight">Packaging Type by Weight</span> (tonnes)</div>
                    <div class="card-body">
                        @if (packagingByWeight != null && packagingByWeight.Any())
                        {
                            double maxW = 0;
                            foreach (var i in packagingByWeight) { var w = (double)i.TotalWeight / 1_000_000.0; if (w > maxW) { maxW = w; } }
                            if (maxW == 0) { maxW = 1; }
                            foreach (var item in packagingByWeight)
                            {
                                var weightTonnes = (double)item.TotalWeight / 1_000_000.0;
                                var pct = maxW > 0 ? (weightTonnes * 100.0 / maxW) : 0;
                                <div class="d-flex justify-content-between align-items-center mb-2 home-overview-row">
                                    <div class="flex-grow-1 me-2">
                                        <div class="home-overview-label">@item.PackagingType</div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar" role="progressbar" style="width: @pct.ToString("F0")%; background: var(--primary-color);"></div>
                                        </div>
                                    </div>
                                    <span class="home-overview-value">@(weightTonnes.ToString("N4")) t</span>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted text-center py-3 mb-0 small"><span data-translate="No packaging weight data">No packaging weight data</span></p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-3 text-center">
            <a href="@Url.Action("Dashboard", "Reporting")" class="btn btn-primary" data-no-tab="true"><i class="bi bi-graph-up-arrow"></i> <span data-translate="View full Reporting Dashboard">View full Reporting Dashboard</span></a>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function() {
    var DURATION_MS = 5000;

    function openLoadingModal(phrase) {
        var modalEl = document.getElementById('datasetLoadingModal');
        var phraseEl = document.getElementById('datasetLoadingPhrase');
        var progressEl = document.getElementById('datasetLoadingProgress');
        if (phraseEl) phraseEl.textContent = phrase;
        if (progressEl) progressEl.style.width = '0%';
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal && modalEl) {
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    }

    function closeLoadingModal() {
        var modalEl = document.getElementById('datasetLoadingModal');
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal && modalEl) {
            var modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
        }
    }

    function runFakeLoad(phrase, onComplete) {
        openLoadingModal(phrase);
        var progressEl = document.getElementById('datasetLoadingProgress');
        var start = Date.now();
        var interval = setInterval(function() {
            var elapsed = Date.now() - start;
            var pct = Math.min(100, (elapsed / DURATION_MS) * 100);
            if (progressEl) progressEl.style.width = pct + '%';
            if (elapsed >= DURATION_MS) {
                clearInterval(interval);
                closeLoadingModal();
                if (onComplete) onComplete();
            }
        }, 50);
    }

    function selectDataset(btn) {
        var datasetKey = btn.getAttribute('data-dataset') || '';
        var phrase = btn.getAttribute('data-phrase') || 'Loading...';
        var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
        fetch('/api/dataset/select', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
            body: JSON.stringify({ datasetKey: datasetKey }),
            credentials: 'same-origin'
        }).then(function(r) {
            if (!r.ok) throw new Error('Failed to set dataset');
            runFakeLoad(phrase, function() { window.location.reload(); });
        }).catch(function(err) {
            console.error(err);
            runFakeLoad(phrase, function() { window.location.reload(); });
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.dataset-card').forEach(function(btn) {
            btn.addEventListener('click', function() {
                selectDataset(this);
            });
        });
    });
})();
</script>
}
