@model EPR.Web.Controllers.ProductsController.ProductDetailVm
@{
    ViewData["Title"] = Model.Product.Name + " | " + (Model.Product.Brand ?? "");
    var p = Model.Product;
    var pf = Model.ProductForm;
    var backUrl = !string.IsNullOrEmpty(Model.ReturnUrl) ? Model.ReturnUrl : Url.Action("Index", "Products");
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a asp-action="Index">Products</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@p.Name</li>
                </ol>
            </nav>
            <h1 class="mb-0">@p.Name | @(p.Brand ?? "—")</h1>
            <p class="text-muted mb-0">@p.Sku @(string.IsNullOrEmpty(p.Gtin) ? "" : " · GTIN " + p.Gtin)</p>
        </div>
        <a href="@backUrl" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
    </div>

    @if (!string.IsNullOrEmpty(p.ImageUrl))
    {
        <div class="mb-4">
            <div class="bg-light d-flex align-items-center justify-content-center rounded border" style="max-width: 320px; height: 240px;">
                <img src="@p.ImageUrl" alt="@p.Name" class="img-fluid" style="max-height: 240px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                <span class="text-muted small p-3 text-center" style="display: none;"><i class="bi bi-image"></i><br />No image</span>
            </div>
        </div>
    }
    else
    {
        <div class="mb-4">
            <div class="bg-light d-flex align-items-center justify-content-center rounded border text-muted" style="max-width: 320px; height: 240px;">
                <span class="small"><i class="bi bi-box-seam" style="font-size: 3rem;"></i><br />No image</span>
            </div>
        </div>
    }

    <div class="row">
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0">Product identification</h5></div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Name</dt><dd class="col-sm-8">@p.Name</dd>
                        <dt class="col-sm-4">Brand</dt><dd class="col-sm-8">@(p.Brand ?? "—")</dd>
                        <dt class="col-sm-4">SKU</dt><dd class="col-sm-8">@p.Sku</dd>
                        <dt class="col-sm-4">GTIN</dt><dd class="col-sm-8">@(p.Gtin ?? "—")</dd>
                        <dt class="col-sm-4">Category</dt><dd class="col-sm-8">@(p.ProductCategory ?? "—")</dd>
                        <dt class="col-sm-4">Sub-category</dt><dd class="col-sm-8">@(p.ProductSubCategory ?? "—")</dd>
                        <dt class="col-sm-4">Country of origin</dt><dd class="col-sm-8">@(p.CountryOfOrigin ?? "—")</dd>
                        <dt class="col-sm-4">Net weight</dt><dd class="col-sm-8">@(p.ProductWeight.HasValue ? p.ProductWeight + " " + (p.ProductWeightUnit ?? "") : "—")</dd>
                        <dt class="col-sm-4">Net volume</dt><dd class="col-sm-8">@(p.ProductVolume.HasValue ? p.ProductVolume + " " + (p.ProductVolumeUnit ?? "") : "—")</dd>
                        <dt class="col-sm-4">Units per package</dt><dd class="col-sm-8">@(p.UnitsPerPackage?.ToString() ?? "—")</dd>
                        <dt class="col-sm-4">Parent unit GTIN</dt><dd class="col-sm-8">@(p.ParentUnitGtin ?? "—")</dd>
                        <dt class="col-sm-4">Description</dt><dd class="col-sm-8">@(p.Description ?? "—")</dd>
                    </dl>
                </div>
            </div>
        </div>

        @if (pf != null)
        {
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header"><h5 class="mb-0">Packaging (form data)</h5></div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-5">Packaging level</dt><dd class="col-sm-7">@(pf.PackagingLevel ?? "—")</dd>
                            <dt class="col-sm-5">Packaging type</dt><dd class="col-sm-7">@(pf.PackagingType ?? "—")</dd>
                            <dt class="col-sm-5">Configuration</dt><dd class="col-sm-7">@(pf.PackagingConfiguration ?? "—")</dd>
                            <dt class="col-sm-5">Total packaging weight (g)</dt><dd class="col-sm-7">@(pf.TotalPackagingWeight?.ToString() ?? "—")</dd>
                            <dt class="col-sm-5">Status</dt><dd class="col-sm-7">@(pf.Status ?? "—")</dd>
                        </dl>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header"><h5 class="mb-0">Retail & distribution</h5></div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-5">Most common pack size</dt><dd class="col-sm-7">@(pf.MostCommonPackSize ?? "—")</dd>
                            <dt class="col-sm-5">Private label</dt><dd class="col-sm-7">@(pf.IsPrivateLabel == true ? "Yes" : "No")</dd>
                            <dt class="col-sm-5">Primary retailers</dt><dd class="col-sm-7">@(string.IsNullOrEmpty(pf.PrimaryRetailersJson) ? "—" : pf.PrimaryRetailersJson)</dd>
                            <dt class="col-sm-5">Geographic distribution</dt><dd class="col-sm-7">@(string.IsNullOrEmpty(pf.GeographicDistributionJson) ? "—" : pf.GeographicDistributionJson)</dd>
                        </dl>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (Model.RelatedAsns.Count > 0)
    {
        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-truck"></i> Related ASN Shipments</h5></div>
            <div class="card-body">
                <p class="text-muted small mb-3">This product appears in the following Advanced Shipping Notices (Distribution).</p>
                <ul class="list-group list-group-flush">
                    @foreach (var asn in Model.RelatedAsns)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <a asp-controller="Distribution" asp-action="Index" asp-route-id="@asn.Id" class="product-detail-link">
                                @asn.AsnNumber
                            </a>
                            <span class="text-muted small">@(asn.ShipDate?.ToString("yyyy-MM-dd") ?? "—")</span>
                        </li>
                    }
                </ul>
            </div>
        </div>
    }

    @if (pf != null && (!string.IsNullOrEmpty(pf.GeneralNotes) || !string.IsNullOrEmpty(pf.PackagingRationale) || !string.IsNullOrEmpty(pf.KnownIssues) || !string.IsNullOrEmpty(pf.ImprovementPlans)))
    {
        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0">Notes & documentation</h5></div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(pf.GeneralNotes)) { <p><strong>General notes:</strong> @pf.GeneralNotes</p> }
                @if (!string.IsNullOrEmpty(pf.PackagingRationale)) { <p><strong>Packaging rationale:</strong> @pf.PackagingRationale</p> }
                @if (!string.IsNullOrEmpty(pf.KnownIssues)) { <p><strong>Known issues:</strong> @pf.KnownIssues</p> }
                @if (!string.IsNullOrEmpty(pf.ImprovementPlans)) { <p><strong>Improvement plans:</strong> @pf.ImprovementPlans</p> }
            </div>
        </div>
    }

    <p class="text-muted small">Created @p.CreatedAt.ToString("yyyy-MM-dd"); @(p.UpdatedAt.HasValue ? "Updated " + p.UpdatedAt.Value.ToString("yyyy-MM-dd") : "")</p>
</div>
